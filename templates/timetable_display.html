<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VTOP Timetable & Registered Courses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        summary::-webkit-details-marker { display: none; }
        details[open] .arrow { transform: rotate(90deg); }
        
        .timetable-cell-content {
            transition: all 0.2s ease-in-out;
        }
        .timetable-cell-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        :root {
            --color-course-0: 239 246 255; /* blue */
            --color-course-1: 240 253 244; /* green */
            --color-course-2: 255 251 235; /* amber */
            --color-course-3: 254 242 242; /* red */
            --color-course-4: 245 243 255; /* violet */
            --color-course-5: 236 252 249; /* teal */
            --color-course-6: 255 247 237; /* orange */
        }
        
        .course-color-0 { background-color: rgb(var(--color-course-0)); }
        .course-color-1 { background-color: rgb(var(--color-course-1)); }
        .course-color-2 { background-color: rgb(var(--color-course-2)); }
        .course-color-3 { background-color: rgb(var(--color-course-3)); }
        .course-color-4 { background-color: rgb(var(--color-course-4)); }
        .course-color-5 { background-color: rgb(var(--color-course-5)); }
        .course-color-6 { background-color: rgb(var(--color-course-6)); }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 antialiased">

<main class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    <!-- Registered Courses Section -->
    <section class="mb-16">
        <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b-4 border-indigo-500 inline-block pb-2">
            Registered Courses
        </h2>
        <div id="course-list" class="space-y-4 mt-6">
            {% set consolidated_courses = {} %}
            {% for course in data.courses %}
                {% if course.course_code not in consolidated_courses %}
                    {% set _ = consolidated_courses.update({
                        course.course_code: {
                            'title': course.course_title,
                            'code': course.course_code,
                            'faculty': course.faculty,
                            'credits': 0.0,
                            'parts': []
                        }
                    }) %}
                {% endif %}
                {% set _ = consolidated_courses[course.course_code].parts.append({
                    'type': course.course_type,
                    'slot': course.slot,
                    'venue': course.venue
                }) %}
                {% set _ = consolidated_courses[course.course_code].update({
                    'credits': consolidated_courses[course.course_code].credits + (course.credits | float(0))
                }) %}
            {% endfor %}

            {% for course_code, course in consolidated_courses.items() %}
            <details class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md overflow-hidden transition-shadow">
                <summary class="p-4 cursor-pointer flex justify-between items-center font-semibold">
                    <div class="flex items-center">
                        <span class="text-indigo-700 font-mono bg-indigo-50 rounded-md px-2 py-1 text-sm mr-4">
                            {{ course.code }}
                        </span>
                        <span class="text-gray-800">{{ course.title }}</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-medium text-gray-500">
                            {{ "%.1f" | format(course.credits) }} Credits
                        </span>
                        <svg class="w-5 h-5 text-gray-500 transform transition-transform arrow"
                             fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                   d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </summary>
                <div class="p-4 border-t border-gray-100 text-sm bg-gray-50">
                    <p class="mb-3"><strong>Faculty:</strong> {{ course.faculty }}</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {% for part in course.parts %}
                        <div class="bg-white border border-gray-200 p-3 rounded-md shadow-sm">
                            <p class="font-semibold text-indigo-700 mb-1">
                                {{ part.type.replace('(', '').replace(')', '').strip() or 'Course' }}
                            </p>
                            <p class="text-sm"><strong>Slot:</strong> {{ part.slot or 'N/A' }}</p>
                            <p class="text-sm"><strong>Venue:</strong> {{ part.venue or 'N/A' }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </details>
            {% endfor %}
        </div>
    </section>

    <!-- Modernized Weekly Timetable Section -->
    <section>
        <h2 class="text-3xl font-bold mb-8 text-gray-800 border-b-4 border-indigo-500 inline-block pb-2">
            Weekly Timetable
        </h2>

        <!-- **FIX:** Added overflow-x-auto for responsiveness on small screens -->
        <div class="bg-white rounded-xl shadow-lg overflow-x-auto ring-1 ring-black ring-opacity-5">
            <table class="w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="w-24 px-4 py-3 text-left text-xs font-semibold text-indigo-800 uppercase tracking-wider">Day</th>
                        {% set time_slots = ["08:00 - 08:50", "08:55 - 09:45", "09:50 - 10:40", "10:45 - 11:35", "11:40 - 12:30", "12:35 - 13:25", "LUNCH", "14:00 - 14:50", "14:55 - 15:45", "15:50 - 16:40", "16:45 - 17:35", "17:40 - 18:30", "18:35 - 19:25"] %}
                        {% for slot in time_slots %}
                            <th scope="col" class="px-2 py-3 text-center text-xs font-semibold text-indigo-800 uppercase tracking-wider {% if slot == 'LUNCH' %}bg-gray-100{% endif %}">
                                {{ slot.split(' - ')[0] }}
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% set days = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'] %}
                    {% set color_index = 0 %}
                    {% set course_colors = {} %}
                    {% set ns = namespace(processed_indices=[]) %}

                    {% for day in days %}
                    <tr class="divide-x divide-gray-200">
                        <td class="px-4 py-2 whitespace-nowrap font-bold text-sm text-indigo-900 bg-gray-50">{{ day }}</td>
                        {% set ns.processed_indices = [] %}

                        {% for slot in time_slots %}
                            {% if loop.index0 not in ns.processed_indices %}
                                {% if slot == 'LUNCH' %}
                                    <td class="bg-gray-100 text-center text-xs font-semibold text-gray-400 italic">LUNCH</td>
                                {% elif data.timetable[day] and data.timetable[day][slot] %}
                                    {% set current_course = data.timetable[day][slot] %}
                                    {% set code = current_course.code %}
                                    
                                    {% if code not in course_colors %}
                                        {% set _ = course_colors.update({code: 'course-color-' ~ (color_index % 7)}) %}
                                        {% set color_index = color_index + 1 %}
                                    {% endif %}

                                    {% set colspan = 1 %}
                                    {% set ns.counting = true %}
                                    {% for i in range(loop.index0 + 1, time_slots|length) %}
                                        {% if ns.counting %}
                                            {% set next_slot = time_slots[i] %}
                                            {% if data.timetable[day] and data.timetable[day][next_slot] and data.timetable[day][next_slot].code == code %}
                                                {% set colspan = colspan + 1 %}
                                            {% else %}
                                                {% set ns.counting = false %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <td colspan="{{ colspan }}" class="p-1.5 align-top">
                                        <div class="timetable-cell-content rounded-lg p-2 flex flex-col h-full {{ course_colors[code] }}">
                                            <p class="font-bold text-xs text-gray-800 leading-tight">
                                                {{ code }}
                                            </p>
                                            <div class="mt-auto text-right">
                                                <span class="text-[10px] font-semibold text-gray-600 bg-white/60 rounded-full px-1.5 py-0.5">{{ current_course.type }}</span>
                                                <p class="text-[11px] text-gray-500 mt-1">@ {{ current_course.venue }}</p>
                                            </div>
                                        </div>
                                    </td>
                                    
                                    {% for i in range(1, colspan) %}
                                        {% set _ = ns.processed_indices.append(loop.index0 + i) %}
                                    {% endfor %}
                                {% else %}
                                    <td></td>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <div class="mt-8 text-right text-lg font-semibold text-gray-700">
        Total Credits: <span class="text-indigo-700">{{ data.total_credits }}</span>
    </div>
</main>

</body>
</html>

